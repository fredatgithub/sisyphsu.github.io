<!DOCTYPE html><html class="theme-next pisces use-motion" lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2"><link rel="stylesheet" href="/css/main.css?v=7.0.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png?v=7.0.0"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=7.0.0"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=7.0.0"><link rel="mask-icon" href="/images/logo.svg?v=7.0.0" color="#222"><script id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Pisces",version:"7.0.0",sidebar:{position:"left",width:300,display:"always",offset:12,b2t:!0,scrollpercent:!0,onmobile:!1,dimmer:!1},fancybox:!1,fastclick:!1,lazyload:!1,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><meta name="description" content="J2EE的服务器集群主要的就是负载均衡和失败转移。负载均衡这个话题都烂大街了，随处可以找到相关文章。但是这些文章中大部分都只谈了负载均衡，顶多再说一下session复制（失败转移的一种解决方案吧）。更有甚者，直接断定“集群中服务器节点宕机丢失的部分session不碍事”。。。现有方案像Tomcat的session交叉复制，如果集群中服务器过多对性能的影响肯定非常之大。像JBoss、WebLogic"><meta name="keywords" content="分布式,J2EE,Failover,高并发"><meta property="og:type" content="article"><meta property="og:title" content="J2EE集群之failover思考"><meta property="og:url" content="https://sulin.me/2011/1NN57EG.html"><meta property="og:site_name" content="小木屋"><meta property="og:description" content="J2EE的服务器集群主要的就是负载均衡和失败转移。负载均衡这个话题都烂大街了，随处可以找到相关文章。但是这些文章中大部分都只谈了负载均衡，顶多再说一下session复制（失败转移的一种解决方案吧）。更有甚者，直接断定“集群中服务器节点宕机丢失的部分session不碍事”。。。现有方案像Tomcat的session交叉复制，如果集群中服务器过多对性能的影响肯定非常之大。像JBoss、WebLogic"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2019-03-04T11:53:48.703Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="J2EE集群之failover思考"><meta name="twitter:description" content="J2EE的服务器集群主要的就是负载均衡和失败转移。负载均衡这个话题都烂大街了，随处可以找到相关文章。但是这些文章中大部分都只谈了负载均衡，顶多再说一下session复制（失败转移的一种解决方案吧）。更有甚者，直接断定“集群中服务器节点宕机丢失的部分session不碍事”。。。现有方案像Tomcat的session交叉复制，如果集群中服务器过多对性能的影响肯定非常之大。像JBoss、WebLogic"><link rel="canonical" href="https://sulin.me/2011/1NN57EG.html"><script id="page.configurations">CONFIG.page={sidebar:""}</script><title>J2EE集群之failover思考 | 小木屋</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-title,.use-motion .comments,.use-motion .menu-item,.use-motion .motion-element,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">小木屋</span> <span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">苏林的个人博客</h1></div><div class="site-nav-toggle"><button aria-label="切换导航栏"><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签<span class="badge">37</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类<span class="badge">10</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档<span class="badge">40</span></a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i><br>站点地图</a></li></ul></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://sulin.me/2011/1NN57EG.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="sulin"><meta itemprop="description" content><meta itemprop="image" content="/images/avatar.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="小木屋"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">J2EE集群之failover思考</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2011-08-21 00:00:00" itemprop="dateCreated datePublished" datetime="2011-08-21T00:00:00+08:00">2011-08-21</time> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2019-03-04 19:53:48" itemprop="dateModified" datetime="2019-03-04T19:53:48+08:00">2019-03-04</time> </span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/寅花晨拾/" itemprop="url" rel="index"><span itemprop="name">寅花晨拾</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><p>J2EE的服务器集群主要的就是负载均衡和失败转移。负载均衡这个话题都烂大街了，随处可以找到相关文章。但是这些文章中大部分都只谈了负载均衡，顶多再说一下session复制（失败转移的一种解决方案吧）。更有甚者，直接断定“集群中服务器节点宕机丢失的部分session不碍事”。。。</p><h1 id="现有方案"><a href="#现有方案" class="headerlink" title="现有方案"></a>现有方案</h1><p>像Tomcat的session交叉复制，如果集群中服务器过多对性能的影响肯定非常之大。</p><p>像JBoss、WebLogic等的服务器链式session复制，如果一个服务器节点宕机，此节点的下一个服务器节点就得负责两个服务器的用户请求。是不是有点怕人奥。</p><p>至于“集群中某个节点宕机就宕机，session丢失无所谓”这样的观点也是挺匪夷所思的，毕竟系统中2000个session同时丢失的后果不是那么容易承担的。</p><h1 id="解决思路"><a href="#解决思路" class="headerlink" title="解决思路"></a>解决思路</h1><p>为了解决上面这些问题，我自己琢磨了一套方案，感觉挺不错的（不知道网上是不是有类似“轮子”，反正我是没有搜索到）。就共享出来，嘿嘿～</p><p>我想到的是缓存服务器和Web服务器双向备份session。</p><h1 id="思路实现"><a href="#思路实现" class="headerlink" title="思路实现"></a>思路实现</h1><p>双向备份就是集群中多个Web服务器分散保存session，同时在缓存服务器中也分散保存这些session （每个session正常情况下只需要复制一次），至于怎么分散各位且听我慢慢说来。</p><h2 id="测试环境"><a href="#测试环境" class="headerlink" title="测试环境"></a>测试环境</h2><p>我使用三台server进行模拟测试，分别为ServerA、ServerB、ServerC。三台服务器分别安置tomcat和memcached服务：</p><ul><li>ServerA：MemcachedA、TomcatA</li><li>ServerB：MemcachedB、TomcatB</li><li>ServerC：MemcachedC、TomcatC</li></ul><h2 id="session分布"><a href="#session分布" class="headerlink" title="session分布"></a>session分布</h2><p>每台server中的tomcat都将自己的session备份在另外两台server中的memcached上：</p><ul><li>TomcatA的session备份在MemcachedB和MemcachedC中。</li><li>TomcatB的session备份在MemcachedC和MemcachedA中。</li><li>TomcatC的session备份在MemcachedB和MemcachedA中。</li></ul><p>在集群正常运行情况下，外部ng/apache等采用Stick-Session方式，将携带sessionid的request固定交由同一台tomcat服务处理。如此，tomcat节点的运行就是完全独立的，互不打扰。session复制备份也是隐式的，tomcat通过哈希码将session隐式备份在其他集群节点中的memcached上。</p><h2 id="如果Tomcat节点宕机怎么办？"><a href="#如果Tomcat节点宕机怎么办？" class="headerlink" title="如果Tomcat节点宕机怎么办？"></a>如果Tomcat节点宕机怎么办？</h2><p>假设TomcatA突然宕机了，那么ng/apache就会无法将请求分发给JSESSIONID相对应的TomcatA上。这时候，ng/apache可以把请求分发给TomcatB或TomcatC，这两台服务器会接收到原属于TomcatA请求。</p><p>它们没有原属于TomcatA相应的JSESSIONID，但可以主动从Memcached集群中根据JSESSIONID寻找这个session。如果找到的话，他们便可以把这个session“收录”为自己的，即将JSESSIONID修改为自己的。</p><p>这样一来，原属于TomcatA的 会话就可以无缝交由TomcatB/TomcatC提供服务。</p><h2 id="如果Memcached节点宕机了怎么办？"><a href="#如果Memcached节点宕机了怎么办？" class="headerlink" title="如果Memcached节点宕机了怎么办？"></a>如果Memcached节点宕机了怎么办？</h2><p>假设MemcachedA宕机，那么整个集群中保存在MemcachedA中的Session备份就丢失，那么TomcatB和TomcatC中的Session就没有了备份。</p><p>如果这时这两台服务器再挂断的话，Session就真的丢失了。为了保证“整个集群中随时都存有同一个Session的备份”，TomcatB和TomcatC应该为自身的Session负责。他们应该主动把自己的Session再备份一次（可以采用临时新建线程的方式，毕竟宕机不是频繁的么。属于特殊情况），再次备份到其他的可用Memcached节点中即可。</p><h1 id="解决它"><a href="#解决它" class="headerlink" title="解决它"></a>解决它</h1><p>关于这个想法，网上有一个开源项目叫做memcached-session-manager。我试用了一下它，感觉不怎么好用。它只能说实现了部分我的想法吧，并且测试中仍然存在session。丢失的情况。</p><p>除此之外，它也有着令人发指的效率问题！我简单测试了一下，普通的tomcat渲染一个JSP页面处理只耗费62.3ms，而添加上这个插件之后，普通的JSP渲染时间竟然变为2.18s ！！！</p><p>靠人不如靠自己、我便自己实现了自己的思路。</p><h2 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h2><p>我通过替换了Tomcat原有的StandardManager（MemcachedManager替换）、StandardSession（MemcachedSession替换）来实现session的集群复制，然后加入了隐式的HttpSession 备份操作。同时也可以根据需要，从Memcached中获取其他节点现有的session。</p><p>我还在Context中加入了一个Valve，该Valve会在每次请求之后根据session的属性是否被修改来判断是否更新缓存（如果session未被修改，那么就完全不必要更新Memcached中缓存的session咯）。 不涉及setAttrubute、removeAttribute的操作是不会触发缓存更新的，并且setAttribute如果设置重复值也是不会引起缓存更新的。</p><p>在XMemcached中我添加了DisConnect事件的监听器、如果某条connect断开（Memcached服务器节点宕机）的话，监听器会主动将Session再次更新入其他正常运行的Memcached节点中。</p><h2 id="实现代码"><a href="#实现代码" class="headerlink" title="实现代码"></a>实现代码</h2><h3 id="Memcached客户端运行期监听器。"><a href="#Memcached客户端运行期监听器。" class="headerlink" title="Memcached客户端运行期监听器。"></a>Memcached客户端运行期监听器。</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> net.sulin.mem;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> net.rubyeye.xmemcached.MemcachedClient;</span><br><span class="line"><span class="keyword">import</span> net.rubyeye.xmemcached.MemcachedClientStateListener;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Memcached客户端运行期监听器，专门用于监听连接断开事件。</span></span><br><span class="line"><span class="comment"> * 如果某条连接断开、则通知相关组件将与此Memcached节点的相关缓存信息重新分布。</span></span><br><span class="line"><span class="comment"> * 以防止出现集群中的重要数据（Session）没有备份。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Copyright</span>(C) 2011-8-20 sulin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Filename</span> MemcachedListener.java </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> sulin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Update</span> sulin</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MemcachedListener</span> <span class="keyword">implements</span> <span class="title">MemcachedClientStateListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> MemcachedTool tool;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> List&lt;InetSocketAddress&gt; disConnectionAddrs;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MemcachedListener</span><span class="params">(MemcachedTool tool)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.tool = tool;</span><br><span class="line">		<span class="keyword">this</span>.disConnectionAddrs = <span class="keyword">new</span> ArrayList&lt;InetSocketAddress&gt;();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDisconnected</span><span class="params">(MemcachedClient client, InetSocketAddress addr)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 防止同一Memcached节点的线程池被重复修复</span></span><br><span class="line">		<span class="keyword">if</span>(!disConnectionAddrs.contains(addr))&#123;</span><br><span class="line">			tool.repairCache();</span><br><span class="line">			disConnectionAddrs.add(addr);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onConnected</span><span class="params">(MemcachedClient client, InetSocketAddress addr)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 如果Memcached节点被修复，则将此节点从故障标记中移除</span></span><br><span class="line">		disConnectionAddrs.remove(addr);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onException</span><span class="params">(MemcachedClient client, Throwable exception)</span> </span>&#123; </span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onShutDown</span><span class="params">(MemcachedClient arg0)</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStarted</span><span class="params">(MemcachedClient arg0)</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="替换Tomcat默认StandardManager的MemcachedManager"><a href="#替换Tomcat默认StandardManager的MemcachedManager" class="headerlink" title="替换Tomcat默认StandardManager的MemcachedManager"></a>替换Tomcat默认StandardManager的MemcachedManager</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> net.sulin.mem;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Enumeration;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> net.rubyeye.xmemcached.exception.MemcachedException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.Container;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.Session;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.session.ManagerBase;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.session.StandardSession;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 此类用于代替Tomcat默认的Manager，它专门用于使用Memcached存储备份Session。</span></span><br><span class="line"><span class="comment"> * 同时Tomcat本身的Session内存存储功能仍然保留（findSession()方法首先从内存</span></span><br><span class="line"><span class="comment"> * 中获取Session，然后再从Memcached集群中获取Session）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Copyright</span>(C) 2011-8-20 sulin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Filename</span> MemcachedManager.java </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> sulin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Update</span> sulin</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MemcachedManager</span> <span class="keyword">extends</span> <span class="title">ManagerBase</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Memcached更新队列最大长度</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> queueSize = <span class="number">200</span>; </span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Memcached服务器节点地址【ip:port】</span></span><br><span class="line">	<span class="keyword">private</span> String addr;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// XMemcached客户端连接池大小</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> poolSize;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// XMemcached支持的协议</span></span><br><span class="line">	<span class="keyword">private</span> String protocol;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 当前可用Memcached客户端对象</span></span><br><span class="line">	<span class="keyword">private</span> MemcachedTool tool = <span class="keyword">null</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 构造方法</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MemcachedManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		setDistributable(<span class="keyword">true</span>); <span class="comment">// attribute必须可序列化</span></span><br><span class="line">		<span class="keyword">this</span>.protocol = <span class="string">"text"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 获取Session</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Session <span class="title">findSession</span><span class="params">(String id)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(id == <span class="keyword">null</span>)</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		Session result = <span class="keyword">super</span>.findSession(id);</span><br><span class="line">		<span class="comment">// 如果result为null、尝试从Memcached集群中获取此Session</span></span><br><span class="line">		<span class="keyword">if</span>(result == <span class="keyword">null</span>)&#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				result = getTool().getFromCache(id, <span class="number">1000</span>);</span><br><span class="line">				<span class="comment">// 如果获取到Session，将它转换为当前服务器节点Session</span></span><br><span class="line">				<span class="keyword">if</span>(result != <span class="keyword">null</span>)</span><br><span class="line">					<span class="keyword">if</span>(result <span class="keyword">instanceof</span> MemcachedSession)&#123;</span><br><span class="line">						MemcachedSession newSession = (MemcachedSession) createSession(generateSessionId());</span><br><span class="line">						Enumeration&lt;?&gt; names = ((MemcachedSession) result).getAttributeNames();</span><br><span class="line">						<span class="keyword">while</span>(names.hasMoreElements())&#123;</span><br><span class="line">							String key = (String) names.nextElement();</span><br><span class="line">							newSession.setAttribute(key, ((MemcachedSession) result).getAttribute(key));</span><br><span class="line">						&#125;</span><br><span class="line">						add(newSession);</span><br><span class="line">						result = newSession;</span><br><span class="line">					&#125;</span><br><span class="line">			&#125; <span class="keyword">catch</span> (TimeoutException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (MemcachedException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 自用的findSession、防止从缓存中读取数据</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> ext</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Session <span class="title">findSession</span><span class="params">(String id, <span class="keyword">boolean</span> ext)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(ext)&#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">super</span>.findSession(id);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> findSession(id);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 删除Session</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(Session session)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>.remove(session);</span><br><span class="line">		<span class="comment">/** 此处已被优化省略</span></span><br><span class="line"><span class="comment">		if(session.isValid())&#123;</span></span><br><span class="line"><span class="comment">			try &#123;</span></span><br><span class="line"><span class="comment">				getTool().deleteFromCache(session.getId(), 1000);</span></span><br><span class="line"><span class="comment">			&#125; catch (TimeoutException e) &#123;</span></span><br><span class="line"><span class="comment">				e.printStackTrace();</span></span><br><span class="line"><span class="comment">			&#125; catch (InterruptedException e) &#123;</span></span><br><span class="line"><span class="comment">				e.printStackTrace();</span></span><br><span class="line"><span class="comment">			&#125; catch (MemcachedException e) &#123;</span></span><br><span class="line"><span class="comment">				e.printStackTrace();</span></span><br><span class="line"><span class="comment">			&#125;</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 新建Session</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> StandardSession <span class="title">getNewSession</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> MemcachedSession(<span class="keyword">this</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 将内置阀门添加入管道中</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContainer</span><span class="params">(Container container)</span> </span>&#123;</span><br><span class="line">		container.getPipeline().addValve(<span class="keyword">new</span> MemcachedValve());</span><br><span class="line">		<span class="keyword">super</span>.setContainer(container);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 执行Manager关闭工作</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">this</span>.tool != <span class="keyword">null</span>)&#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				tool.close();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">super</span>.destroy();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/** 尚未覆写方法 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getRejectedSessions</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRejectedSessions</span><span class="params">(<span class="keyword">int</span> rejectedSessions)</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">()</span> <span class="keyword">throws</span> ClassNotFoundException, IOException </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unload</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/****************************setter、getter**************************/</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getQueueSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> queueSize;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setQueueSize</span><span class="params">(<span class="keyword">int</span> queueSize)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.queueSize = queueSize;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getAddr</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> addr;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAddr</span><span class="params">(String addr)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.addr = addr;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPoolSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> poolSize;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPoolSize</span><span class="params">(<span class="keyword">int</span> poolSize)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.poolSize = poolSize;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> MemcachedTool <span class="title">getTool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 判断tool是否为null，如果为null则创建这个tool</span></span><br><span class="line">		<span class="keyword">if</span>(tool == <span class="keyword">null</span>)&#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				tool = <span class="keyword">new</span> MemcachedTool(<span class="keyword">this</span>);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> tool;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMaxInactiveInterval</span><span class="params">(<span class="keyword">int</span> maxInactiveInterval)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 设置Session最大有效期</span></span><br><span class="line">		<span class="keyword">this</span>.maxInactiveInterval = maxInactiveInterval*<span class="number">60</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProtocol</span><span class="params">(String protocol)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(!<span class="string">"text"</span>.equals(protocol) &amp;&amp; !<span class="string">"binary"</span>.equals(protocol))&#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"protocol["</span>+protocol+<span class="string">"] does not exist"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">this</span>.protocol = protocol;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getProtocol</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> protocol;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="替换Tomcat自带StandardSession的MemcachedSession"><a href="#替换Tomcat自带StandardSession的MemcachedSession" class="headerlink" title="替换Tomcat自带StandardSession的MemcachedSession"></a>替换Tomcat自带StandardSession的MemcachedSession</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> net.sulin.mem;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.Manager;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.session.StandardSession;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 覆写StandardSession类，将Tomcat的Session实现类中添加一个</span></span><br><span class="line"><span class="comment"> * isChange标志位，在其他地方需要根据这个isChange标志位判断是否需要</span></span><br><span class="line"><span class="comment"> * 将此Session对象更新入Memcached服务器集群中。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Copyright</span>(C) 2011-8-20 sulin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Filename</span> MemcachedSession.java </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> sulin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Update</span> sulin</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MemcachedSession</span> <span class="keyword">extends</span> <span class="title">StandardSession</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">8052215026550611559L</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 当前Request中此Session是否被修改</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">boolean</span> isChange;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 构造方法</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MemcachedSession</span><span class="params">(Manager manager)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(manager);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 修改属性</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAttribute</span><span class="params">(String name, Object value)</span> </span>&#123;</span><br><span class="line">		Object obj = getAttribute(name);</span><br><span class="line">		<span class="keyword">if</span>(obj!=<span class="keyword">null</span>)</span><br><span class="line">			<span class="keyword">if</span>(obj.equals(value))</span><br><span class="line">				<span class="keyword">return</span>; <span class="comment">// attribute值相同、不需要修改</span></span><br><span class="line">		<span class="keyword">super</span>.setAttribute(name, value);</span><br><span class="line">		setChange(<span class="keyword">true</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 删除属性</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeAttribute</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">		System.out.println(name);</span><br><span class="line">		Object obj = getAttribute(name);</span><br><span class="line">		<span class="keyword">if</span>(obj==<span class="keyword">null</span>)</span><br><span class="line">				<span class="keyword">return</span>; <span class="comment">// attribute不存在、不需要修改</span></span><br><span class="line">		<span class="keyword">super</span>.removeAttribute(name);</span><br><span class="line">		setChange(<span class="keyword">true</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/****************** getter、setter *****************/</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setChange</span><span class="params">(<span class="keyword">boolean</span> isChange)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.isChange = isChange;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isChange</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> isChange;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Tomcat与Memcached的连接桥梁。"><a href="#Tomcat与Memcached的连接桥梁。" class="headerlink" title="Tomcat与Memcached的连接桥梁。"></a>Tomcat与Memcached的连接桥梁。</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> net.sulin.mem;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ArrayBlockingQueue;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.BlockingQueue;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpSession;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.Session;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.code.yanf4j.core.impl.StandardSocketOption;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> net.rubyeye.xmemcached.MemcachedClient;</span><br><span class="line"><span class="keyword">import</span> net.rubyeye.xmemcached.MemcachedClientBuilder;</span><br><span class="line"><span class="keyword">import</span> net.rubyeye.xmemcached.XMemcachedClientBuilder;</span><br><span class="line"><span class="keyword">import</span> net.rubyeye.xmemcached.command.BinaryCommandFactory;</span><br><span class="line"><span class="keyword">import</span> net.rubyeye.xmemcached.exception.MemcachedException;</span><br><span class="line"><span class="keyword">import</span> net.rubyeye.xmemcached.utils.AddrUtil;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Tomcat应用程序与Memcached集群的连接桥梁。</span></span><br><span class="line"><span class="comment"> * 用于提供相关的添加数据、修改数据、删除数据操作。</span></span><br><span class="line"><span class="comment"> * 并且它也负责在某一天连接意外断开时通过重置Session分布</span></span><br><span class="line"><span class="comment"> * 来避免数据出现没有备份（备份机宕机）的情况。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Copyright</span>(C) 2011-8-20 sulin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Filename</span> MemcachedTool.java </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> sulin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Update</span> sulin</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MemcachedTool</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 更新缓存操作队列</span></span><br><span class="line">	<span class="keyword">private</span> BlockingQueue&lt;HttpSession&gt; queue;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Session在缓存中的过期时间（分钟）</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> expire = <span class="number">30</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 客户端对象</span></span><br><span class="line">	<span class="keyword">private</span> MemcachedClient client = <span class="keyword">null</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Manager对象</span></span><br><span class="line">	<span class="keyword">private</span> MemcachedManager manager;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 初始化Memcached客户端，并设置相关参数</span></span><br><span class="line"><span class="comment">	 * 这些参数需要通过MemcachedManager配置</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> manager MemcachedManager对象</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MemcachedTool</span><span class="params">(MemcachedManager manager)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.manager = manager;</span><br><span class="line">		<span class="comment">// 初始化操作队列</span></span><br><span class="line">		<span class="keyword">this</span>.queue = <span class="keyword">new</span> ArrayBlockingQueue&lt;HttpSession&gt;(<span class="keyword">this</span>.manager.getQueueSize());</span><br><span class="line">		<span class="comment">// 设置Session在缓存中的超时时间</span></span><br><span class="line">		<span class="keyword">this</span>.expire = <span class="keyword">this</span>.manager.getMaxInactiveInterval();</span><br><span class="line">		<span class="comment">// 初始化MemcachedClient</span></span><br><span class="line">		MemcachedClientBuilder builder = <span class="keyword">new</span> XMemcachedClientBuilder(</span><br><span class="line">				AddrUtil.getAddresses(<span class="keyword">this</span>.manager.getAddr()));</span><br><span class="line">		builder.setConnectionPoolSize(<span class="keyword">this</span>.manager.getPoolSize());</span><br><span class="line">		builder.setSocketOption(StandardSocketOption.SOSNDBUF, <span class="number">16</span>*<span class="number">1024</span>);</span><br><span class="line">		builder.setSocketOption(StandardSocketOption.TCPNODELAY, <span class="keyword">true</span>);</span><br><span class="line">		builder.addStateListener(<span class="keyword">new</span> MemcachedListener(<span class="keyword">this</span>));</span><br><span class="line">		<span class="keyword">if</span>(<span class="string">"binary"</span>.equals(manager.getProtocol()))&#123;</span><br><span class="line">			builder.setCommandFactory(<span class="keyword">new</span> BinaryCommandFactory());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">this</span>.client = builder.build();</span><br><span class="line">		<span class="keyword">this</span>.client.setEnableHeartBeat(<span class="keyword">false</span>);</span><br><span class="line">		<span class="comment">// 启动备份Session线程</span></span><br><span class="line">		backupProcess();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 将Session放入更新队列【Session更新入缓存为异步操作】</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> session 需要放入队列的Session</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> timeout 超时时间、秒</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> InterruptedException</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveToCache</span><span class="params">(HttpSession session, <span class="keyword">int</span> timeout)</span> </span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> InterruptedException</span>&#123;</span><br><span class="line">		queue.offer(session, timeout, TimeUnit.SECONDS);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 尝试从缓存中取出指定sessionId的Session【同步操作】</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> sessionId  取出的Session的id</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> timeout 超时时间、秒</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> TimeoutException</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> InterruptedException</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> MemcachedException</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Session <span class="title">getFromCache</span><span class="params">(String sessionId, <span class="keyword">int</span> timeout)</span> </span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> TimeoutException, InterruptedException, MemcachedException </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> client.get(sessionId, timeout);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 尝试从缓存中删除指定sessionId的Session【同步操作】</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> sessionId</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> TimeoutException</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> InterruptedException</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> MemcachedException</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteFromCache</span><span class="params">(String sessionId, <span class="keyword">long</span> timeout)</span> </span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> TimeoutException, InterruptedException, MemcachedException</span>&#123;</span><br><span class="line">		client.delete(sessionId, timeout);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 当某个连接断开时、可以通过此方法将所有Session重新缓存</span></span><br><span class="line"><span class="comment">	 * 特殊情况特殊对待，此处忽略新建线程带来的压力（这个方法一般很少需要调用）。</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">repairCache</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">				Session[] sessions = manager.findSessions();</span><br><span class="line">				<span class="keyword">for</span>(Session session : sessions)&#123;</span><br><span class="line">					<span class="keyword">try</span> &#123;</span><br><span class="line">						client.set(session.getId(), manager.getMaxInactiveInterval(), session);</span><br><span class="line">					&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">						e.printStackTrace();</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;).start();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 关闭当前Memcached客户端</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">		client.shutdown();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 更新Session队列的备份线程</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">backupProcess</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">				<span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">					<span class="comment">// 获取队列中的Session</span></span><br><span class="line">					HttpSession session = <span class="keyword">null</span>;</span><br><span class="line">					<span class="keyword">synchronized</span>(queue)&#123;</span><br><span class="line">						<span class="keyword">try</span> &#123;</span><br><span class="line">							session = queue.take();</span><br><span class="line">						&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">							e.printStackTrace();</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">if</span>(session == <span class="keyword">null</span>)</span><br><span class="line">						<span class="keyword">continue</span>;</span><br><span class="line">					<span class="comment">// 将取出的Session保存或更新入 Memcached 中</span></span><br><span class="line">					<span class="keyword">try</span> &#123;</span><br><span class="line">						MemcachedSession temp = (MemcachedSession) session;</span><br><span class="line">						<span class="keyword">if</span>(temp.isChange())&#123;</span><br><span class="line">							client.set(session.getId(), expire*<span class="number">60</span>, session);</span><br><span class="line">						&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">							<span class="keyword">if</span>(<span class="string">"binary"</span>.equals(manager.getProtocol()))&#123;</span><br><span class="line">								client.touch(session.getId(), expire*<span class="number">60</span>);</span><br><span class="line">							&#125;</span><br><span class="line">						&#125;</span><br><span class="line">						temp.setChange(<span class="keyword">false</span>);</span><br><span class="line">					<span class="comment">// 存入失败，将Session重新放入队列。等待下次循环</span></span><br><span class="line">					&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">						<span class="keyword">synchronized</span>(queue)&#123;</span><br><span class="line">							queue.offer(session);</span><br><span class="line">						&#125;</span><br><span class="line">						e.printStackTrace();</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;).start();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="插入Tomcat的Valve"><a href="#插入Tomcat的Valve" class="headerlink" title="插入Tomcat的Valve"></a>插入Tomcat的Valve</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> net.sulin.mem;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.Cookie;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpSession;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.Manager;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.Session;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.Request;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.Response;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.valves.ValveBase;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Memcached阀门，用于在请求收尾时将此请求相关Session进行更新操作</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Copyright</span>(C) 2011-8-20 sulin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Filename</span> MemcachedValve.java </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> sulin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Update</span> sulin</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MemcachedValve</span> <span class="keyword">extends</span> <span class="title">ValveBase</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(Request request, Response response)</span> </span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">		getNext().invoke(request, response);</span><br><span class="line">		afterInvoke(request, response);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Request处理后、进行Session的更新缓存处理</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterInvoke</span><span class="params">(Request request, Response response)</span></span>&#123;</span><br><span class="line">		<span class="comment">// 获取sessionId</span></span><br><span class="line">		Session session = request.getSessionInternal();</span><br><span class="line">		<span class="keyword">if</span>(session == <span class="keyword">null</span>)</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		<span class="comment">// Session不为空、判断是否需要更新入缓存并执行相应操作</span></span><br><span class="line">		<span class="keyword">if</span>(session <span class="keyword">instanceof</span> MemcachedSession)&#123;</span><br><span class="line">			MemcachedSession temp = (MemcachedSession) session;</span><br><span class="line">			<span class="keyword">if</span>(!temp.getId().equals(request.getRequestedSessionId()))&#123;</span><br><span class="line">				Cookie cookie = <span class="keyword">new</span> Cookie(<span class="string">"JSESSIONID"</span>, session.getId());</span><br><span class="line">				cookie.setPath(<span class="string">"/"</span>);</span><br><span class="line">				response.addCookie(cookie);</span><br><span class="line">			&#125;</span><br><span class="line">			Manager manager = session.getManager();</span><br><span class="line">			<span class="keyword">if</span>(manager <span class="keyword">instanceof</span> MemcachedManager)&#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					((MemcachedManager)manager).getTool().saveToCache((HttpSession)session, <span class="number">1000</span>);</span><br><span class="line">				&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="配置Tomcat"><a href="#配置Tomcat" class="headerlink" title="配置Tomcat"></a>配置Tomcat</h2><p>将以上代码打包后放入lib中，然后在context.xml中添加如下配置：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Manager</span> 	<span class="attr">className</span>=<span class="string">"net.sulin.mem.MemcachedManager"</span></span></span><br><span class="line"><span class="tag">			<span class="attr">queueSize</span>=<span class="string">"300"</span></span></span><br><span class="line"><span class="tag">			<span class="attr">addr</span>=<span class="string">"127.0.0.1:11211 127.0.0.1:11212 127.0.0.1:11213"</span></span></span><br><span class="line"><span class="tag">			<span class="attr">poolSize</span>=<span class="string">"3"</span></span></span><br><span class="line"><span class="tag">			<span class="attr">protocol</span>=<span class="string">"text"</span></span></span><br><span class="line"><span class="tag">			<span class="attr">maxInactiveInterval</span>=<span class="string">"30"</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">className : 替换的Manager</span></span><br><span class="line"><span class="comment">queueSize : 我采用了异步队列更新 HttpSession 缓存，队列用于存储需要更新的HttpSession对象，如果值太小的话。队列空间不够用</span></span><br><span class="line"><span class="comment">addr : 就是 Memcached 的服务器地址和端口了，每个之间用空格隔开（XMemcached就是这样处理的，我不想费事）</span></span><br><span class="line"><span class="comment">poolSize : XMemcached 客户端与 Memcached 服务器的连接池，据XMemcached 作者说即便是高并发也 30 之内吧，因为这是用NIO处理的，不需要太多连接。</span></span><br><span class="line"><span class="comment">protocol : XMemcached 客户端与 Memcached 服务器之间的数据传输协议，可以是“text”也可以是“binary”， binary 的话它可以使用 XMemcached 的touch方法等， 但是需要 1.4 以上版本的XMemcached。 我没使用</span></span><br><span class="line"><span class="comment">maxInactiveInterval ：HttpSession过期时间， 分钟为单位</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br></pre></td></tr></table></figure><p>大功告成～～～</p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>添加了这个session复制功能之后的Tomcat居然比正常的Tomcat处理JSP页面还快。处理一个正常同样JSP页面只需要57.5ms，哈哈，快了几毫秒（应该是测试数据误差）。</p><p>在测试中，我胡乱关闭Tomcat服务和Memcached服务。但每次请求的session都没有遇见丢失的情况。嘿嘿，感觉挺不错的，性能上也是看不到影响。</p><p>但是就目前而言，这是没有经受过任何生产环境考验的！</p></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者： </strong>sulin</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://sulin.me/2011/1NN57EG.html" title="J2EE集群之failover思考">https://sulin.me/2011/1NN57EG.html</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/分布式/" rel="tag"># 分布式</a> <a href="/tags/J2EE/" rel="tag"># J2EE</a> <a href="/tags/Failover/" rel="tag"># Failover</a> <a href="/tags/高并发/" rel="tag"># 高并发</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2011/3J50SKB.html" rel="next" title="Java中char的编码方式与多语言区分"><i class="fa fa-chevron-left"></i> Java中char的编码方式与多语言区分</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/2011/2DNHE4W.html" rel="prev" title="汇编object file not found错误">汇编object file not found错误 <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article></div></div><div class="comments" id="gitalk-container"></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><div class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="sulin"><p class="site-author-name" itemprop="name">sulin</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">40</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">10</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">37</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="mailto:sulinixl@gmail.com" title="E-Mail &rarr; mailto:sulinixl@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i></a> </span><span class="links-of-author-item"><a href="https://github.com/sisyphsu" title="GitHub &rarr; https://github.com/sisyphsu" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i></a> </span><span class="links-of-author-item"><a href="https://twitter.com/sulinixl" title="Twitter &rarr; https://twitter.com/sulinixl" rel="noopener" target="_blank"><i class="fa fa-fw fa-twitter"></i></a> </span><span class="links-of-author-item"><a href="https://stackoverflow.com/users/5932976/sulin" title="StackOverflow &rarr; https://stackoverflow.com/users/5932976/sulin" rel="noopener" target="_blank"><i class="fa fa-fw fa-stack-overflow"></i></a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-link"></i> Links</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="https://xbipay.com" title="https://xbipay.com" rel="noopener" target="_blank">币付[xbipay.com]</a></li><li class="links-of-blogroll-item"><a href="https://hiiex.com" title="https://hiiex.com" rel="noopener" target="_blank">Hiiex[hiiex.com]</a></li><li class="links-of-blogroll-item"><a href="https://quking.com" title="https://quking.com" rel="noopener" target="_blank">酷赢[quking.com]</a></li></ul></div></div></div><div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#现有方案"><span class="nav-number">1.</span> <span class="nav-text">现有方案</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#解决思路"><span class="nav-number">2.</span> <span class="nav-text">解决思路</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#思路实现"><span class="nav-number">3.</span> <span class="nav-text">思路实现</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#测试环境"><span class="nav-number">3.1.</span> <span class="nav-text">测试环境</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#session分布"><span class="nav-number">3.2.</span> <span class="nav-text">session分布</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#如果Tomcat节点宕机怎么办？"><span class="nav-number">3.3.</span> <span class="nav-text">如果Tomcat节点宕机怎么办？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#如果Memcached节点宕机了怎么办？"><span class="nav-number">3.4.</span> <span class="nav-text">如果Memcached节点宕机了怎么办？</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#解决它"><span class="nav-number">4.</span> <span class="nav-text">解决它</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#解决办法"><span class="nav-number">4.1.</span> <span class="nav-text">解决办法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实现代码"><span class="nav-number">4.2.</span> <span class="nav-text">实现代码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Memcached客户端运行期监听器。"><span class="nav-number">4.2.1.</span> <span class="nav-text">Memcached客户端运行期监听器。</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#替换Tomcat默认StandardManager的MemcachedManager"><span class="nav-number">4.2.2.</span> <span class="nav-text">替换Tomcat默认StandardManager的MemcachedManager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#替换Tomcat自带StandardSession的MemcachedSession"><span class="nav-number">4.2.3.</span> <span class="nav-text">替换Tomcat自带StandardSession的MemcachedSession</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Tomcat与Memcached的连接桥梁。"><span class="nav-number">4.2.4.</span> <span class="nav-text">Tomcat与Memcached的连接桥梁。</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#插入Tomcat的Valve"><span class="nav-number">4.2.5.</span> <span class="nav-text">插入Tomcat的Valve</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置Tomcat"><span class="nav-number">4.3.</span> <span class="nav-text">配置Tomcat</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#总结"><span class="nav-number">5.</span> <span class="nav-text">总结</span></a></li></ol></div></div></div><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; 2018 – <span itemprop="copyrightYear">2019</span> <span class="with-love" id="animate"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">sulin</span></div><div style="display:none"><script src="//s96.cnzz.com/z_stat.php?id=1276400179&web_id=1276400179"></script></div></div></footer></div><script>"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script src="/lib/jquery/index.js?v=2.1.3"></script><script src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script src="/js/src/utils.js?v=7.0.0"></script><script src="/js/src/motion.js?v=7.0.0"></script><script src="/js/src/affix.js?v=7.0.0"></script><script src="/js/src/schemes/pisces.js?v=7.0.0"></script><script src="/js/src/scrollspy.js?v=7.0.0"></script><script src="/js/src/post-details.js?v=7.0.0"></script><script src="/js/src/bootstrap.js?v=7.0.0"></script><script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css"><script src="//cdn.jsdelivr.net/npm/js-md5@0.7.3/src/md5.min.js"></script><script>var gitalk=new Gitalk({clientID:"e392da7bb9c29fcbab05",clientSecret:"379a583593484a9958b32f40ef62f7ffa7a36059",repo:"sisyphsu.github.io",owner:"sisyphsu",admin:["sisyphsu"],id:md5(location.pathname),distractionFreeMode:"true"});gitalk.render("gitalk-container")</script></body></html>